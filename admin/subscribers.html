<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin - Billakos Model Horse</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicons -->
  <link rel="icon" href="https://i.postimg.cc/nLyg39tP/6205-B9-F2-AE7-D-4105-AE47-78-BF6-B5-B531-A.png" type="image/png">

  <style>
    #content { display: none; }
    body { font-family: 'Oswald', sans-serif; margin: 20px; }
    textarea, .output { width: 100%; margin-top: 10px; }
    .output { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; }
    #emailListContainer { margin-bottom: 30px; }
    #emailsDisplay { border: 1px solid #ccc; padding: 10px; max-height: 150px; overflow-y: auto; white-space: normal; }
    #copyEmailsBtn { margin-top: 10px; padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #copyEmailsBtn:hover { background-color: #45a049; }
  </style>

  <script>
    function checkPassword() {
      const password = prompt("Please enter the password:");
      const correctPassword = "billakos123";

      if (password === correctPassword) {
        document.getElementById("content").style.display = "block";
      } else {
        alert("Incorrect password! Redirecting to admin page.");
        window.location.href = "https://billakosmodelhorses.com/admin.html";
      }
    }
  </script>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, serverTimestamp, 
      query, orderBy, deleteDoc, doc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJUJbeZ9ceRwaQOCboy79LEwbN-I7R9ro",
      authDomain: "billakosmodelhorses.firebaseapp.com",
      projectId: "billakosmodelhorses",
      storageBucket: "billakosmodelhorses.appspot.com",
      messagingSenderId: "988607299628",
      appId: "1:988607299628:web:b7c2139b095a0afba8d189",
      measurementId: "G-RWHNVMHN2P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ====== LOAD EMAILS ======
    async function loadEmails() {
      const emailContainer = document.getElementById("emailsDisplay");
      emailContainer.textContent = "Loading emails...";

      try {
        const querySnapshot = await getDocs(collection(db, "emails"));
        const emails = querySnapshot.docs.map(doc => doc.data().email);

        if (emails.length === 0) {
          emailContainer.textContent = "No subscriber emails found.";
          return;
        }

        emailContainer.textContent = emails.join(", ");
        
        // Copy button functionality
        const copyBtn = document.getElementById("copyEmailsBtn");
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(emails.join(", "))
            .then(() => alert("Emails copied to clipboard!"))
            .catch(err => console.error("Failed to copy:", err));
        };
      } catch (error) {
        console.error("Error loading emails:", error);
        emailContainer.textContent = "âŒ Failed to load emails.";
      }
    }

    // ====== COMMENTS FUNCTIONS (unchanged except minor cleanup) ======
    async function loadComments() {
      const commentsCollection = collection(db, 'comments');
      const q = query(commentsCollection, orderBy('timestamp', 'desc'));
      const querySnapshot = await getDocs(q);
      const comments = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderComments(comments);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('commentForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const name = document.getElementById('nameInput').value;
        const text = document.getElementById('commentInput').value;

        if (name && text) {
          try {
            await addDoc(collection(db, 'comments'), {
              name: name,
              text: text,
              timestamp: serverTimestamp()
            });
            document.getElementById('nameInput').value = '';
            document.getElementById('commentInput').value = '';
            loadComments();
          } catch (error) {
            console.error("Error adding comment: ", error);
          }
        }
      });

      loadEmails(); // â† Load emails when page opens
      loadComments(); // â† Load comments when page opens
    });

    async function deleteComment(commentId) {
      if (confirm('Are you sure you want to delete this note?')) {
        await deleteDoc(doc(db, 'comments', commentId));
        loadComments();
      }
    }

    async function editComment(commentId, newText) {
      const commentDoc = doc(db, 'comments', commentId);
      await updateDoc(commentDoc, { text: newText });
      loadComments();
    }

    function renderComments(comments) {
      const commentsSection = document.getElementById('commentsSection');
      commentsSection.innerHTML = '';
      comments.forEach(comment => {
        const div = document.createElement('div');
        div.style.marginBottom = "20px";
        div.style.borderBottom = "1px solid #ccc";
        div.style.padding = "10px";

        const name = document.createElement('p');
        name.style.fontWeight = "bold";
        name.textContent = `${comment.name}:`;

        const text = document.createElement('p');
        text.innerHTML = comment.text.replace(/\n/g, '<br>');

        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.onclick = () => deleteComment(comment.id);

        const copy = document.createElement('button');
        copy.textContent = 'Copy';
        copy.onclick = () => {
          navigator.clipboard.writeText(comment.text);
          alert('Note copied to clipboard!');
        };

        const edit = document.createElement('button');
        edit.textContent = 'Edit';
        edit.onclick = () => {
          const newText = prompt('Edit comment:', comment.text);
          if (newText !== null) editComment(comment.id, newText);
        };

        div.append(name, text, del, copy, edit);
        commentsSection.appendChild(div);
      });
    }
  </script>
</head>

<body onload="checkPassword()">
  <div id="content">
    <header>
      <h1>Admin Dashboard</h1>
      <nav><a href="https://billakosmodelhorses.com/admin.html">Admin Page</a></nav>
    </header>

    <!-- EMAILS SECTION -->
    <section id="emailListContainer">
      <h2>ðŸ“§ Subscriber Emails</h2>
      <div id="emailsDisplay">Loading emails...</div>
      <button id="copyEmailsBtn">Copy All Emails</button>
    </section>

    <!-- COMMENTS SECTION -->
    <div class="comments-display-container">
      <h3>Comments:</h3>
      <div id="commentsSection"></div>
    </div>

    <div class="comment-container">
      <h2>Leave a Comment:</h2>
      <form id="commentForm">
        <label for="nameInput">Your Name:</label><br>
        <input type="text" id="nameInput" required><br>
        <label for="commentInput">Your Comment:</label><br>
        <textarea id="commentInput" rows="4" required></textarea><br>
        <button type="submit">Submit Comment</button>
      </form>
    </div>
  </div>
</body>
</html>
